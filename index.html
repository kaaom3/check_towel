<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
        }
        /* Styles for active tab */
        .tab-active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #3730a3; /* indigo-800 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">üè® ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</h1>
            <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</p>
        </div>

        <!-- Main Form -->
        <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
            <form id="towelForm" class="space-y-8">
                <!-- Top Row: Room Number & Customer Name -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Room Number -->
                    <div>
                        <label for="roomNumber" class="block text-sm font-semibold text-gray-700 mb-2">
                            üè† ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á
                        </label>
                        <input 
                            type="text" 
                            id="roomNumber" 
                            name="roomNumber"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 101, 205 (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ)"
                        >
                        <div id="roomWarning" class="mt-2 text-sm text-red-600 hidden">
                            ‚ö†Ô∏è ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </div>
                    </div>

                    <!-- Customer Name -->
                    <div>
                        <label for="customerName" class="block text-sm font-semibold text-gray-700 mb-2">
                            üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-gray-500 text-xs">(‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á)</span>
                        </label>
                        <input 
                            type="text" 
                            id="customerName" 
                            name="customerName"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
                        >
                        <div id="customerNameRequired" class="mt-2 text-sm text-orange-600 hidden">
                            üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á
                        </div>
                    </div>
                </div>

                <!-- Middle Row: Status & Towel Count -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Check In -->
                            <label class="relative cursor-pointer">
                                <input 
                                    type="radio" 
                                    name="status" 
                                    value="Check In"
                                    class="sr-only peer"
                                    required
                                >
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                                    <div class="text-2xl mb-2">üè®</div>
                                    <div class="font-semibold text-gray-700 peer-checked:text-green-700">Check In</div>
                                    <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</div>
                                    <!-- Check mark -->
                                    <div class="absolute top-2 right-2 w-5 h-5 bg-green-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </label>

                            <!-- Check Out -->
                            <label class="relative cursor-pointer">
                                <input 
                                    type="radio" 
                                    name="status" 
                                    value="Check Out"
                                    class="sr-only peer"
                                    required
                                >
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300">
                                    <div class="text-2xl mb-2">üö™</div>
                                    <div class="font-semibold text-gray-700 peer-checked:text-blue-700">Check Out</div>
                                    <div class="text-xs text-gray-500 mt-1">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
                                    <!-- Check mark -->
                                    <div class="absolute top-2 right-2 w-5 h-5 bg-blue-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Towel Count -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            üèä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß
                        </label>
                        <div class="flex items-center justify-center space-x-4">
                            <!-- Decrease Button -->
                            <button 
                                type="button" 
                                id="decreaseBtn"
                                class="w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                            </button>

                            <!-- Count Display -->
                            <div class="flex-1 max-w-xs">
                                <input 
                                    type="number" 
                                    id="towelCount" 
                                    name="towelCount"
                                    min="1"
                                    max="20"
                                    value="1"
                                    class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors text-2xl font-bold text-center bg-gray-50"
                                    readonly
                                    required
                                >
                            </div>

                            <!-- Increase Button -->
                            <button 
                                type="button" 
                                id="increaseBtn"
                                class="w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-center mt-2 text-sm text-gray-500">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡∏´‡∏£‡∏∑‡∏≠ - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Notes & Submit -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-end">
                    <!-- Notes -->
                    <div class="lg:col-span-2">
                        <label for="notes" class="block text-sm font-semibold text-gray-700 mb-2">
                            üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                        </label>
                        <textarea 
                            id="notes" 
                            name="notes"
                            rows="3"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors resize-none"
                            placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                        ></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg transition-colors duration-200 text-lg shadow-lg hover:shadow-xl h-[84px] flex items-center justify-center"
                        >
                            <span id="submitText">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                            <span id="loadingText" class="loading">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
                            </span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Success/Error Messages -->
            <div id="message" class="mt-6 p-4 rounded-lg hidden">
                <p id="messageText" class="font-medium"></p>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="max-w-4xl mx-auto mt-12">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <!-- Tab Headers -->
                <nav class="flex border-b mb-6">
                    <button data-tab="records" class="tab-btn tab-active font-semibold py-3 px-6 border-b-2 transition-colors">
                        üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </button>
                    <button data-tab="export" class="tab-btn font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-800 transition-colors">
                        üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                    </button>
                </nav>

                <!-- Tab Panels -->
                <div>
                    <!-- Records Panel -->
                    <div id="panel-records" class="p-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                            <button 
                                id="refreshBtn"
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                            >
                                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                            </button>
                        </div>
                        <div id="recordsContainer" class="overflow-x-auto">
                            <div class="text-center py-8 text-gray-500">
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                            </div>
                        </div>
                    </div>

                    <!-- Summary Panel -->
                    <div id="panel-export" class="hidden p-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h3>
                        <!-- Report Options -->
                        <div class="flex flex-col md:flex-row items-center gap-6 bg-gray-50 p-6 rounded-xl border">
                            <!-- Radio buttons for type -->
                            <div class="flex items-center gap-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="reportType" value="daily" class="form-radio h-5 w-5 text-indigo-600" checked>
                                    <span class="text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="reportType" value="monthly" class="form-radio h-5 w-5 text-indigo-600">
                                    <span class="text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                </label>
                            </div>

                            <!-- Date/Month Pickers -->
                            <div class="flex-grow">
                                <input type="date" id="reportDate" class="w-full px-4 py-2 border rounded-lg">
                                <input type="month" id="reportMonth" class="w-full px-4 py-2 border rounded-lg hidden">
                            </div>

                            <!-- Get Report Button -->
                            <div>
                                <button id="getSummaryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors w-full md:w-auto flex items-center justify-center min-w-[140px]">
                                    üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                </button>
                            </div>
                        </div>
                        
                        <!-- Summary Result Container -->
                        <div id="summaryResultContainer" class="mt-6 min-h-[150px]">
                            <div class="text-center py-8 text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSgc7SBt_GyKtUkziObMUZGDvY5BtTLO4JK-udSGSG-Hv5Nw_JcBl4TKLc6yY7F8TWjw/exec';
        
        let todayRecords = [];
        let lastKnownFirstRecordTimestamp = null; // Variable to track the latest record for real-time updates

        function checkRoomDuplicate(roomNumber) {
            if (!roomNumber) return null;
            const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            
            const duplicateRecord = todayRecords.find(record => {
                if (!record[0] || !record[1]) return false;
                
                try {
                    const [day, month, year] = record[0].split(' ')[0].split('/');
                    const recordDate = new Date(`${year}-${month}-${day}`);
                    const recordDateStr = recordDate.toLocaleDateString('en-CA');
                    return recordDateStr === todayStr && record[1].toString().trim() === roomNumber.trim();
                } catch(e) {
                    return false;
                }
            });
            return duplicateRecord || null;
        }

        function getTimeDifference(recordTimeStr) {
             try {
                const [datePart, timePart] = recordTimeStr.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hours, minutes] = timePart.split(':');
                const recordTime = new Date(year, month - 1, day, hours, minutes);
                const now = new Date();
                const diffMs = now - recordTime;
                const diffMinutes = Math.floor(diffMs / 60000);
                if (diffMinutes < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                if (diffMinutes < 60) return `${diffMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                const diffHours = Math.floor(diffMinutes / 60);
                return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            } catch (e) {
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
            }
        }

        document.getElementById('towelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            const formData = new FormData(this);
            const roomNumber = formData.get('roomNumber').trim();
            const customerName = formData.get('customerName').trim();
            
            if (!roomNumber && !customerName) {
                showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            const duplicateRecord = checkRoomDuplicate(roomNumber);
            if (roomNumber && duplicateRecord) {
                const timeDiff = getTimeDifference(duplicateRecord[0]);
                showMessage(`‚ùå ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${timeDiff})`, 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            loadingText.classList.add('show');
            
            try {
                const data = {
                    action: 'addRecord',
                    roomNumber, customerName,
                    status: formData.get('status'),
                    towelCount: parseInt(formData.get('towelCount')),
                    notes: formData.get('notes') || ''
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    this.reset();
                    loadRecords();
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                loadingText.classList.remove('show');
            }
        });

        async function loadRecords() {
            const container = document.getElementById('recordsContainer');
            try {
                const response = await fetch(SCRIPT_URL + '?action=getRecords', { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Check if the latest record has changed before redrawing the whole table.
                    // This makes the real-time update more efficient and less jarring for the user.
                    const newFirstRecordTimestamp = result.data.length > 0 ? result.data[0][0] : null;
                    if (newFirstRecordTimestamp !== lastKnownFirstRecordTimestamp) {
                        console.log('New data detected. Refreshing list.');
                        lastKnownFirstRecordTimestamp = newFirstRecordTimestamp;
                        todayRecords = result.data;
                        displayRecords(result.data);
                    }
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error during background refresh:', error);
                // To avoid showing an error on a silent background refresh, 
                // we only show the error if the table hasn't been loaded at all.
                if (!container.querySelector('table')) {
                    container.innerHTML = `<div class="text-center py-8 text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}</div>`;
                }
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            container.innerHTML = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3">${record[0] || ''}</td>
                                <td class="px-4 py-3 font-medium">${record[1] || ''}</td>
                                <td class="px-4 py-3">${record[2] || ''}</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${record[3] === 'Check In' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                        ${record[3] || ''}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center font-medium">${record[4] || ''}</td>
                                <td class="px-4 py-3">${record[5] || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            message.className = `mt-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            message.classList.remove('hidden');
            setTimeout(() => message.classList.add('hidden'), 5000);
        }

        // --- Towel count controls ---
        const towelCountInput = document.getElementById('towelCount');
        document.getElementById('increaseBtn').addEventListener('click', () => {
            if (parseInt(towelCountInput.value) < 20) towelCountInput.value = parseInt(towelCountInput.value) + 1;
        });
        document.getElementById('decreaseBtn').addEventListener('click', () => {
            if (parseInt(towelCountInput.value) > 1) towelCountInput.value = parseInt(towelCountInput.value) - 1;
        });

        document.getElementById('refreshBtn').addEventListener('click', loadRecords);

        // --- Real-time validation ---
        document.getElementById('roomNumber').addEventListener('input', function() {
            const roomNumber = this.value.trim();
            const roomWarning = document.getElementById('roomWarning');
            if (roomNumber) {
                const duplicateRecord = checkRoomDuplicate(roomNumber);
                if (duplicateRecord) {
                    roomWarning.textContent = `‚ö†Ô∏è ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${getTimeDifference(duplicateRecord[0])})`;
                    roomWarning.classList.remove('hidden');
                } else {
                    roomWarning.classList.add('hidden');
                }
            } else {
                roomWarning.classList.add('hidden');
            }
        });

        // --- Tab Logic ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanels = {
            records: document.getElementById('panel-records'),
            export: document.getElementById('panel-export')
        };
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                tabBtns.forEach(b => b.classList.remove('tab-active'));
                this.classList.add('tab-active');
                Object.values(tabPanels).forEach(p => p.classList.add('hidden'));
                tabPanels[this.dataset.tab].classList.remove('hidden');
            });
        });

        // --- Report Type Toggle Logic ---
        const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');
        const reportDateInput = document.getElementById('reportDate');
        const reportMonthInput = document.getElementById('reportMonth');
        const summaryResultContainer = document.getElementById('summaryResultContainer');

        reportTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'daily') {
                    reportDateInput.classList.remove('hidden');
                    reportMonthInput.classList.add('hidden');
                } else {
                    reportDateInput.classList.add('hidden');
                    reportMonthInput.classList.remove('hidden');
                }
                summaryResultContainer.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            });
        });

        // --- Summary Report Logic ---
        document.getElementById('getSummaryBtn').addEventListener('click', getSummaryReport);

        async function getSummaryReport() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const dateInput = (reportType === 'daily') ? reportDateInput : reportMonthInput;
            const dateValue = dateInput.value;
            const getSummaryBtn = document.getElementById('getSummaryBtn');

            if (!dateValue) {
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-yellow-100 text-yellow-800">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${reportType === 'daily' ? '‡∏ß‡∏±‡∏ô' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>`;
                return;
            }
            
            getSummaryBtn.disabled = true;
            getSummaryBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            summaryResultContainer.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...</div>';

            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getSummary');
                url.searchParams.append('type', reportType);
                url.searchParams.append('date', dateValue);
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySummary(result.data, reportType, dateValue);
                } else {
                    throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error fetching summary:', error);
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-800">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            } finally {
                getSummaryBtn.disabled = false;
                getSummaryBtn.innerHTML = 'üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            }
        }

        function displaySummary(data, type, date) {
            let title = '';
            if (type === 'daily') {
                const [year, month, day] = date.split('-');
                title = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day}/${month}/${year}`;
            } else {
                const [year, month] = date.split('-');
                const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                title = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[parseInt(month, 10) - 1]} ${parseInt(year)}`;
            }

            if (data.totalRecords === 0) {
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-blue-100 text-blue-800"><h4 class="font-bold text-lg mb-2">${title}</h4><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p></div>`;
                return;
            }

            summaryResultContainer.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-xl border">
                    <h4 class="font-bold text-xl mb-4 text-gray-800">${title}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow-sm"><div class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold text-indigo-600">${data.totalRecords}</div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><div class="text-sm text-gray-500">‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold text-indigo-600">${data.totalTowels}</div></div>
                        <div></div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200"><div class="font-semibold text-green-800">Check In</div><div class="mt-2"><span class="text-2xl font-bold text-green-700">${data.checkInTowels}</span><span class="text-gray-600"> ‡∏ú‡∏∑‡∏ô</span></div><div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å ${data.checkInCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"><div class="font-semibold text-blue-800">Check Out</div><div class="mt-2"><span class="text-2xl font-bold text-blue-700">${data.checkOutTowels}</span><span class="text-gray-600"> ‡∏ú‡∏∑‡∏ô</span></div><div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å ${data.checkOutCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                    </div>
                </div>`;
        }

        window.addEventListener('load', loadRecords);

        // For real-time data, automatically refresh records every 10 seconds.
        setInterval(loadRecords, 10000); // Poll every 10 seconds

    </script>
</body>
</html>

