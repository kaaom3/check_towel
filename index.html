<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
        }
        /* Styles for active tab */
        .tab-active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #3730a3; /* indigo-800 */
        }
        /* Accordion icon rotation */
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">üè® ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</h1>
        </div>

        <!-- Location Selection -->
        <div id="locationSelection" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button data-location="HIHH" class="location-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-4 rounded-lg transition-colors text-xl shadow-lg">
                    üìç HIHH
                </button>
                <button data-location="LOCKER" class="location-btn bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-4 rounded-lg transition-colors text-xl shadow-lg">
                     locker
                </button>
            </div>
        </div>
        
        <!-- Main Content (Initially Hidden) -->
        <div id="mainContent" class="hidden">
            <!-- Main Form -->
            <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl">
                <div class="flex justify-between items-center p-6 border-b">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                        <p class="text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <span id="selectedLocationText" class="font-semibold text-indigo-600"></span></p>
                    </div>
                    <button id="changeLocationBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                    </button>
                </div>

                <div class="px-6 pb-8 pt-6">
                    <form id="towelForm" class="space-y-8">
                        <input type="hidden" id="location" name="location">
                        <!-- Top Row: Room Number & Customer Name -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Room Number -->
                            <div class="relative">
                                <label for="roomNumber" class="block text-sm font-semibold text-gray-700 mb-2">
                                    üè† ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á / Locker
                                </label>
                                <input 
                                    type="text" 
                                    id="roomNumber" 
                                    name="roomNumber"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 101, 205"
                                    autocomplete="off"
                                >
                                <div id="towelLimitInfoRoom" class="mt-2 text-sm text-gray-600 hidden"></div>
                                <div id="roomSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg hidden max-h-40 overflow-y-auto"></div>
                            </div>

                            <!-- Customer Name -->
                            <div class="relative">
                                <label for="customerName" class="block text-sm font-semibold text-gray-700 mb-2">
                                    üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-gray-500 text-xs">(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="customerName" 
                                    name="customerName"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
                                     autocomplete="off"
                                >
                                <div id="towelLimitInfoName" class="mt-2 text-sm text-gray-600 hidden"></div>
                                <div id="nameSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg hidden max-h-40 overflow-y-auto"></div>
                            </div>
                        </div>

                        <!-- Middle Row: Status & Towel Count -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Status -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-4">
                                    üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                </label>
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Check In -->
                                    <label class="relative cursor-pointer">
                                        <input 
                                            type="radio" 
                                            name="status" 
                                            value="Check In"
                                            class="sr-only peer"
                                            required
                                        >
                                        <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                                            <div class="text-2xl mb-2">üè®</div>
                                            <div class="font-semibold text-gray-700 peer-checked:text-green-700">Check In</div>
                                            <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</div>
                                            <!-- Check mark -->
                                            <div class="absolute top-2 right-2 w-5 h-5 bg-green-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </label>

                                    <!-- Check Out -->
                                    <label class="relative cursor-pointer">
                                        <input 
                                            type="radio" 
                                            name="status" 
                                            value="Check Out"
                                            class="sr-only peer"
                                            required
                                        >
                                        <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300">
                                            <div class="text-2xl mb-2">üö™</div>
                                            <div class="font-semibold text-gray-700 peer-checked:text-blue-700">Check Out</div>
                                            <div class="text-xs text-gray-500 mt-1">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
                                            <!-- Check mark -->
                                            <div class="absolute top-2 right-2 w-5 h-5 bg-blue-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Towel Count -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-4">
                                    üèä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß
                                </label>
                                <div class="flex items-center justify-center space-x-4">
                                    <!-- Decrease Button -->
                                    <button 
                                        type="button" 
                                        id="decreaseBtn"
                                        class="w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                                    >
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                        </svg>
                                    </button>

                                    <!-- Count Display -->
                                    <div class="flex-1 max-w-xs">
                                        <input 
                                            type="number" 
                                            id="towelCount" 
                                            name="towelCount"
                                            min="1"
                                            max="20"
                                            value="1"
                                            class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors text-2xl font-bold text-center bg-gray-50"
                                            readonly
                                            required
                                        >
                                    </div>

                                    <!-- Increase Button -->
                                    <button 
                                        type="button" 
                                        id="increaseBtn"
                                        class="w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                                    >
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-center mt-2 text-sm text-gray-500">
                                    ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡∏´‡∏£‡∏∑‡∏≠ - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Row: Notes & Submit -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-end">
                            <!-- Notes -->
                            <div class="lg:col-span-2">
                                <label for="notes" class="block text-sm font-semibold text-gray-700 mb-2">
                                    üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                                </label>
                                <textarea 
                                    id="notes" 
                                    name="notes"
                                    rows="3"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors resize-none"
                                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                                ></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div>
                                <button 
                                    type="submit" 
                                    id="submitBtn"
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg transition-colors duration-200 text-lg shadow-lg hover:shadow-xl h-[84px] flex items-center justify-center"
                                >
                                    <span id="submitText">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                    <span id="loadingText" class="loading">
                                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
                                    </span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Success/Error Messages -->
                <div id="message" class="mx-6 mb-6 p-4 rounded-lg hidden">
                    <p id="messageText" class="font-medium"></p>
                </div>
            </div>

            <!-- Data/Tabs Section -->
            <div class="max-w-4xl mx-auto mt-12 bg-white rounded-2xl shadow-xl">
                <!-- Collapsible Data Header -->
                <div id="dataHeader" class="flex justify-between items-center p-6 cursor-pointer">
                    <h2 class="text-2xl font-bold text-gray-800">üìä ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                    <svg id="dataChevron" class="w-6 h-6 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                <!-- Collapsible Data Content -->
                <div id="dataContent" class="p-8 hidden">
                    <!-- Tab Headers -->
                    <nav class="flex border-b mb-6">
                        <button data-tab="records" class="tab-btn tab-active font-semibold py-3 px-6 border-b-2 transition-colors">
                            üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        </button>
                        <button data-tab="summary" class="tab-btn font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-800 transition-colors">
                            üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                        </button>
                    </nav>

                    <!-- Tab Panels -->
                    <div>
                        <!-- Records Panel -->
                        <div id="panel-records" class="p-4">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                                <button 
                                    id="refreshBtn"
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                                >
                                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                </button>
                            </div>
                            <!-- Daily Summary Container -->
                            <div id="dailySummaryContainer" class="mb-6">
                                <!-- Summary content will be injected here by JS -->
                            </div>
                            <div id="recordsContainer" class="space-y-4">
                                <div class="text-center py-8 text-gray-500">
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                                </div>
                            </div>
                             <!-- Pagination Controls -->
                            <div id="paginationContainer" class="flex justify-center items-center mt-6">
                                <!-- Pagination controls will be injected here -->
                            </div>
                        </div>

                        <!-- Summary Panel -->
                        <div id="panel-summary" class="hidden p-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h3>
                            <!-- Report Options -->
                            <div class="flex flex-col md:flex-row items-center gap-6 bg-gray-50 p-6 rounded-xl border">
                                <!-- Radio buttons for type -->
                                <div class="flex items-center gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="reportType" value="daily" class="form-radio h-5 w-5 text-indigo-600" checked>
                                        <span class="text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="reportType" value="monthly" class="form-radio h-5 w-5 text-indigo-600">
                                        <span class="text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                    </label>
                                </div>

                                <!-- Date/Month Pickers -->
                                <div class="flex-grow">
                                    <input type="date" id="reportDate" class="w-full px-4 py-2 border rounded-lg">
                                    <input type="month" id="reportMonth" class="w-full px-4 py-2 border rounded-lg hidden">
                                </div>

                                <!-- Get Report Button -->
                                <div>
                                    <button id="getSummaryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors w-full md:w-auto flex items-center justify-center min-w-[140px]">
                                        üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Summary Result Container -->
                            <div id="summaryResultContainer" class="mt-6 min-h-[150px]">
                                <div class="text-center py-8 text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSgc7SBt_GyKtUkziObMUZGDvY5BtTLO4JK-udSGSG-Hv5Nw_JcBl4TKLc6yY7F8TWjw/exec';
        
        let allRecords = [];
        let lastKnownFirstRecordTimestamp = null;
        let currentPage = 1;
        const recordsPerPage = 5;
        let selectedLocation = '';

        function getFormattedDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function checkTowelLimit(identifier, by = 'room') {
            if (!identifier) return 0;
            const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            
            let totalTowelsToday = 0;
            const identifierIndex = by === 'room' ? 2 : 3;

            const todaysRecordsForIdentifier = allRecords.filter(record => {
                if (!record[0] || !record[identifierIndex]) return false;
                try {
                    const [day, month, year] = record[0].split(' ')[0].split('/');
                    const recordDate = new Date(`${year}-${month}-${day}`);
                    const recordDateStr = recordDate.toLocaleDateString('en-CA');
                    return recordDateStr === todayStr && record[identifierIndex].toString().trim() === identifier.trim();
                } catch(e) {
                    return false;
                }
            });

            todaysRecordsForIdentifier.forEach(record => {
                totalTowelsToday += parseInt(record[5], 10) || 0;
            });

            return totalTowelsToday;
        }


        document.getElementById('towelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            const formData = new FormData(this);
            const roomNumber = formData.get('roomNumber').trim();
            const customerName = formData.get('customerName').trim();
            const newTowelCount = parseInt(formData.get('towelCount'));
            
            if (!roomNumber && !customerName) {
                showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á/Locker ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }

            const identifier = roomNumber || customerName;
            const checkBy = roomNumber ? 'room' : 'name';

            const existingTowels = checkTowelLimit(identifier, checkBy);
            if (existingTowels + newTowelCount > 5) {
                let message = `‚ùå ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ú‡∏∑‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô\n- ${identifier} ‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ${existingTowels} ‡∏ú‡∏∑‡∏ô`;
                 if (existingTowels >= 5) {
                    message = `‚ùå ${identifier} ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö 5 ‡∏ú‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
                }
                showMessage(message, 'error', 10000);
                return;
            }
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            loadingText.classList.add('show');
            
            try {
                const data = {
                    action: 'addRecord',
                    location: formData.get('location'),
                    roomNumber, 
                    customerName,
                    status: formData.get('status'),
                    towelCount: newTowelCount,
                    notes: formData.get('notes') || ''
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    document.getElementById('roomNumber').value = '';
                    document.getElementById('customerName').value = '';
                    document.getElementById('notes').value = '';
                    loadRecords();
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                loadingText.classList.remove('show');
            }
        });

        async function loadRecords() {
            const container = document.getElementById('recordsContainer');
            try {
                const response = await fetch(SCRIPT_URL + '?action=getRecords', { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const fetchedRecords = result.data;
                    const newFirstRecordTimestamp = fetchedRecords.length > 0 ? fetchedRecords[0][0] : null;

                    if (newFirstRecordTimestamp !== lastKnownFirstRecordTimestamp) {
                        console.log('New data detected. Refreshing list.');
                        lastKnownFirstRecordTimestamp = newFirstRecordTimestamp;
                        allRecords = fetchedRecords;
                        currentPage = 1;

                        displayDailySummary(allRecords);
                        updateRecordView();
                    }
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error during background refresh:', error);
                if (!container.querySelector('div')) {
                    container.innerHTML = `<div class="text-center py-8 text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}</div>`;
                }
            }
        }
        
        function updateRecordView() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const paginatedRecords = allRecords.slice(startIndex, endIndex);

            displayRecords(paginatedRecords);
            setupPagination();
        }

        function setupPagination() {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(allRecords.length / recordsPerPage);

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';

            container.innerHTML = `
                <button id="prevPageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-l disabled:opacity-50 disabled:cursor-not-allowed" ${prevDisabled}>
                    &laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
                <span class="px-4 py-2 bg-white text-gray-700 border-t border-b border-indigo-500">
                    ‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}
                </span>
                <button id="nextPageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-r disabled:opacity-50 disabled:cursor-not-allowed" ${nextDisabled}>
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;
                </button>
            `;

            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateRecordView();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateRecordView();
                }
            });
        }

        function displayDailySummary(records) {
            const container = document.getElementById('dailySummaryContainer');
            const todayStr = getFormattedDate(new Date());

            const todaysData = records.filter(record => record[0] && record[0].startsWith(todayStr));

            if (todaysData.length === 0) {
                container.innerHTML = `<div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center text-gray-600"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p></div>`;
                return;
            }
            
            const createSummaryObject = () => ({
                totalRecords: 0, checkInCount: 0, checkOutCount: 0,
                checkInTowels: 0, checkOutTowels: 0, totalTowels: 0
            });

            const summary = {
                TOTAL: createSummaryObject(),
                HIHH: createSummaryObject(),
                LOCKER: createSummaryObject()
            };

            todaysData.forEach(row => {
                const location = row[1]; // HIHH or LOCKER
                const status = row[4];
                const towelCount = parseInt(row[5], 10) || 0;

                const updateCounts = (obj) => {
                    obj.totalRecords++;
                    obj.totalTowels += towelCount;
                    if (status === 'Check In') {
                        obj.checkInCount++;
                        obj.checkInTowels += towelCount;
                    } else if (status === 'Check Out') {
                        obj.checkOutCount++;
                        obj.checkOutTowels += towelCount;
                    }
                };
                
                updateCounts(summary.TOTAL);
                if (summary[location]) {
                    updateCounts(summary[location]);
                }
            });
            
            const renderSummaryCard = (title, data, color) => {
                if (data.totalRecords === 0) return '';
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border-t-4 ${color}">
                        <h5 class="font-bold text-gray-800 text-lg">${title}</h5>
                        <div class="text-sm text-gray-500 mt-2">‡∏£‡∏ß‡∏° ${data.totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ${data.totalTowels} ‡∏ú‡∏∑‡∏ô</div>
                        <div class="flex justify-around mt-3 text-center">
                            <div>
                                <div class="font-semibold text-green-700">Check In</div>
                                <div class="text-md font-bold">${data.checkInTowels} <span class="text-xs">‡∏ú‡∏∑‡∏ô</span></div>
                            </div>
                            <div>
                                <div class="font-semibold text-blue-700">Check Out</div>
                                <div class="text-md font-bold">${data.checkOutTowels} <span class="text-xs">‡∏ú‡∏∑‡∏ô</span></div>
                            </div>
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-xl border">
                    <h4 class="font-bold text-xl mb-3 text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${todayStr})</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderSummaryCard('‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', summary.TOTAL, 'border-indigo-500')}
                        ${renderSummaryCard('HIHH', summary.HIHH, 'border-blue-500')}
                        ${renderSummaryCard('LOCKER', summary.LOCKER, 'border-green-500')}
                    </div>
                </div>`;
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>';
                return;
            }

            const groupedRecords = records.reduce((acc, record) => {
                const dateKey = record[0].split(' ')[0];
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(record);
                return acc;
            }, {});

            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            const todayStr = getFormattedDate(today);
            const yesterdayStr = getFormattedDate(yesterday);

            let html = '';
            
            for (const dateKey in groupedRecords) {
                let dateLabel = dateKey;
                if (dateKey === todayStr) dateLabel = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${dateKey})`;
                if (dateKey === yesterdayStr) dateLabel = `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (${dateKey})`;

                const recordsForDate = groupedRecords[dateKey];
                const isExpanded = true;
                
                html += `
                <div class="border rounded-lg overflow-hidden bg-white">
                    <button class="accordion-header w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                        <span class="font-semibold text-gray-700">${dateLabel}</span>
                        <svg class="accordion-chevron w-5 h-5 text-gray-500 transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="accordion-content overflow-hidden ${isExpanded ? '' : 'hidden'}">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50 border-b">
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recordsForDate.map(record => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3">${record[0].split(' ')[1] || ''}</td>
                                            <td class="px-4 py-3">${record[1] || ''}</td>
                                            <td class="px-4 py-3 font-medium">${record[2] || ''}</td>
                                            <td class="px-4 py-3">${record[3] || ''}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${record[4] === 'Check In' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                    ${record[4] || ''}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center font-medium">${record[5] || ''}</td>
                                            <td class="px-4 py-3">${record[6] || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `;
            }

            container.innerHTML = html;
            addAccordionListeners();
        }

        function addAccordionListeners() {
            document.querySelectorAll('.accordion-header').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const chevron = button.querySelector('.accordion-chevron');
                    content.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            });
        }

        function showMessage(text, type, duration = 5000) {
            const message = document.getElementById('message');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageText.style.whiteSpace = 'pre-wrap';
            message.className = `mx-6 mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            message.classList.remove('hidden');
            setTimeout(() => {
                message.classList.add('hidden');
                messageText.style.whiteSpace = 'normal';
            }, duration);
        }

        // --- Towel count controls ---
        const towelCountInput = document.getElementById('towelCount');
        document.getElementById('increaseBtn').addEventListener('click', () => {
            if (parseInt(towelCountInput.value) < 20) towelCountInput.value = parseInt(towelCountInput.value) + 1;
        });
        document.getElementById('decreaseBtn').addEventListener('click', () => {
            if (parseInt(towelCountInput.value) > 1) towelCountInput.value = parseInt(towelCountInput.value) - 1;
        });

        document.getElementById('refreshBtn').addEventListener('click', loadRecords);

        // --- Collapsible Data Logic ---
        document.getElementById('dataHeader').addEventListener('click', () => {
            document.getElementById('dataContent').classList.toggle('hidden');
            document.getElementById('dataChevron').classList.toggle('rotate-180');
        });

        // --- Tab Logic ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanels = {
            records: document.getElementById('panel-records'),
            summary: document.getElementById('panel-summary')
        };
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                tabBtns.forEach(b => b.classList.remove('tab-active'));
                this.classList.add('tab-active');
                Object.values(tabPanels).forEach(p => p.classList.add('hidden'));
                tabPanels[this.dataset.tab].classList.remove('hidden');
            });
        });

        // --- Report Type Toggle Logic ---
        const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');
        const reportDateInput = document.getElementById('reportDate');
        const reportMonthInput = document.getElementById('reportMonth');
        const summaryResultContainer = document.getElementById('summaryResultContainer');

        reportTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'daily') {
                    reportDateInput.classList.remove('hidden');
                    reportMonthInput.classList.add('hidden');
                } else {
                    reportDateInput.classList.add('hidden');
                    reportMonthInput.classList.remove('hidden');
                }
                summaryResultContainer.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            });
        });

        // --- Summary Report Logic ---
        document.getElementById('getSummaryBtn').addEventListener('click', getSummaryReport);

        async function getSummaryReport() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const dateInput = (reportType === 'daily') ? reportDateInput : reportMonthInput;
            const dateValue = dateInput.value;
            const getSummaryBtn = document.getElementById('getSummaryBtn');

            if (!dateValue) {
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-yellow-100 text-yellow-800">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${reportType === 'daily' ? '‡∏ß‡∏±‡∏ô' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>`;
                return;
            }
            
            getSummaryBtn.disabled = true;
            getSummaryBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            summaryResultContainer.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...</div>';

            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getSummary');
                url.searchParams.append('type', reportType);
                url.searchParams.append('date', dateValue);
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySummary(result.data, reportType, dateValue);
                } else {
                    throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error fetching summary:', error);
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-800">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            } finally {
                getSummaryBtn.disabled = false;
                getSummaryBtn.innerHTML = 'üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            }
        }

        function displaySummary(data, type, date) {
            let title = '';
            if (type === 'daily') {
                const [year, month, day] = date.split('-');
                title = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day}/${month}/${year}`;
            } else {
                const [year, month] = date.split('-');
                const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                title = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[parseInt(month, 10) - 1]} ${parseInt(year)}`;
            }

            if (data.totalRecords === 0) {
                summaryResultContainer.innerHTML = `<div class="p-4 rounded-lg bg-blue-100 text-blue-800"><h4 class="font-bold text-lg mb-2">${title}</h4><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p></div>`;
                return;
            }

            summaryResultContainer.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-xl border">
                    <h4 class="font-bold text-xl mb-4 text-gray-800">${title}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow-sm"><div class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold text-indigo-600">${data.totalRecords}</div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><div class="text-sm text-gray-500">‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold text-indigo-600">${data.totalTowels}</div></div>
                        <div></div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200"><div class="font-semibold text-green-800">Check In</div><div class="mt-2"><span class="text-2xl font-bold text-green-700">${data.checkInTowels}</span><span class="text-gray-600"> ‡∏ú‡∏∑‡∏ô</span></div><div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å ${data.checkInCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"><div class="font-semibold text-blue-800">Check Out</div><div class="mt-2"><span class="text-2xl font-bold text-blue-700">${data.checkOutTowels}</span><span class="text-gray-600"> ‡∏ú‡∏∑‡∏ô</span></div><div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å ${data.checkOutCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                    </div>
                </div>`;
        }
        
        // --- Autocomplete Suggestions ---
        function handleSuggestions(inputValue, by, suggestionsContainerId, inputId) {
            const suggestionsContainer = document.getElementById(suggestionsContainerId);
            if (!inputValue) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            const todayStr = new Date().toLocaleDateString('en-CA');
            const identifierIndex = by === 'room' ? 2 : 3;

            const todaysRecords = allRecords.filter(record => {
                if (!record[0] || !record[identifierIndex]) return false;
                try {
                    const [day, month, year] = record[0].split(' ')[0].split('/');
                    const recordDate = new Date(`${year}-${month}-${day}`);
                    return recordDate.toLocaleDateString('en-CA') === todayStr;
                } catch (e) { return false; }
            });

            const uniqueIdentifiers = [...new Set(todaysRecords.map(record => record[identifierIndex].toString().trim()))];
            
            const filteredSuggestions = uniqueIdentifiers.filter(item => 
                item.toLowerCase().startsWith(inputValue.toLowerCase())
            );

            if (filteredSuggestions.length > 0) {
                suggestionsContainer.innerHTML = filteredSuggestions.map(suggestion => 
                    `<div class="p-2 hover:bg-gray-100 cursor-pointer suggestion-item">${suggestion}</div>`
                ).join('');
                suggestionsContainer.classList.remove('hidden');

                suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const inputElement = document.getElementById(inputId);
                        inputElement.value = item.textContent;
                        suggestionsContainer.classList.add('hidden');
                        inputElement.dispatchEvent(new Event('input')); 
                    });
                });
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }
        
        // --- Real-time Towel Limit Check ---
        function handleTowelLimitCheck(identifier, by, infoElementId) {
            const infoElement = document.getElementById(infoElementId);
            if (!identifier) {
                infoElement.classList.add('hidden');
                return;
            }
            
            const existingTowels = checkTowelLimit(identifier, by);
            const remaining = 5 - existingTowels;

            if (existingTowels > 0) {
                infoElement.innerHTML = `(‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${existingTowels} ‡∏ú‡∏∑‡∏ô, ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ${Math.max(0, remaining)} ‡∏ú‡∏∑‡∏ô)`;
                infoElement.classList.remove('hidden');

                if (remaining <= 0) {
                    infoElement.classList.remove('text-gray-600', 'text-green-600');
                    infoElement.classList.add('text-red-600');
                } else {
                    infoElement.classList.remove('text-gray-600', 'text-red-600');
                    infoElement.classList.add('text-green-600');
                }
            } else {
                 infoElement.classList.add('hidden');
            }
        }

        document.getElementById('roomNumber').addEventListener('input', function() {
            const value = this.value.trim();
            handleTowelLimitCheck(value, 'room', 'towelLimitInfoRoom');
            handleSuggestions(value, 'room', 'roomSuggestions', 'roomNumber');
        });
        
        document.getElementById('customerName').addEventListener('input', function() {
            const value = this.value.trim();
            handleTowelLimitCheck(value, 'name', 'towelLimitInfoName');
            handleSuggestions(value, 'name', 'nameSuggestions', 'customerName');
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.relative')) {
                document.getElementById('roomSuggestions').classList.add('hidden');
                document.getElementById('nameSuggestions').classList.add('hidden');
            }
        });


        // --- Location Selection Logic ---
        document.querySelectorAll('.location-btn').forEach(button => {
            button.addEventListener('click', function() {
                selectedLocation = this.dataset.location;
                document.getElementById('location').value = selectedLocation;
                document.getElementById('selectedLocationText').textContent = selectedLocation;
                
                document.getElementById('locationSelection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                loadRecords();
            });
        });

        document.getElementById('changeLocationBtn').addEventListener('click', () => {
            document.getElementById('locationSelection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            allRecords = [];
            lastKnownFirstRecordTimestamp = null;
        });

        // For real-time data, automatically refresh records every 10 seconds.
        setInterval(() => {
            if (selectedLocation) { // Only refresh if a location is selected
                loadRecords();
            }
        }, 10000); // Poll every 10 seconds

    </script>
</body>
</html>

