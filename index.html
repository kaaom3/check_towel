<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
        }
        /* Styles for active tab */
        .tab-active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">üè® ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</h1>
            <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</p>
        </div>

        <!-- Main Form -->
        <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
            <form id="towelForm" class="space-y-8">
                <!-- Form content remains the same -->
                 <!-- Top Row: Room Number & Customer Name -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Room Number -->
                    <div>
                        <label for="roomNumber" class="block text-sm font-semibold text-gray-700 mb-2">
                            üè† ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á
                        </label>
                        <input 
                            type="text" 
                            id="roomNumber" 
                            name="roomNumber"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 101, 205 (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ)"
                        >
                        <div id="roomWarning" class="mt-2 text-sm text-red-600 hidden">
                            ‚ö†Ô∏è ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </div>
                    </div>

                    <!-- Customer Name -->
                    <div>
                        <label for="customerName" class="block text-sm font-semibold text-gray-700 mb-2">
                            üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-gray-500 text-xs">(‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á)</span>
                        </label>
                        <input 
                            type="text" 
                            id="customerName" 
                            name="customerName"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-lg"
                            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
                        >
                        <div id="customerNameRequired" class="mt-2 text-sm text-orange-600 hidden">
                            üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á
                        </div>
                    </div>
                </div>

                <!-- Middle Row: Status & Towel Count -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Check In -->
                            <label class="relative cursor-pointer">
                                <input 
                                    type="radio" 
                                    name="status" 
                                    value="Check In"
                                    class="sr-only peer"
                                    required
                                >
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                                    <div class="text-2xl mb-2">üè®</div>
                                    <div class="font-semibold text-gray-700 peer-checked:text-green-700">Check In</div>
                                    <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</div>
                                    <!-- Check mark -->
                                    <div class="absolute top-2 right-2 w-5 h-5 bg-green-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </label>

                            <!-- Check Out -->
                            <label class="relative cursor-pointer">
                                <input 
                                    type="radio" 
                                    name="status" 
                                    value="Check Out"
                                    class="sr-only peer"
                                    required
                                >
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-4 text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300">
                                    <div class="text-2xl mb-2">üö™</div>
                                    <div class="font-semibold text-gray-700 peer-checked:text-blue-700">Check Out</div>
                                    <div class="text-xs text-gray-500 mt-1">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
                                    <!-- Check mark -->
                                    <div class="absolute top-2 right-2 w-5 h-5 bg-blue-500 rounded-full hidden peer-checked:flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Towel Count -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            üèä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß
                        </label>
                        <div class="flex items-center justify-center space-x-4">
                            <!-- Decrease Button -->
                            <button 
                                type="button" 
                                id="decreaseBtn"
                                class="w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                            </button>

                            <!-- Count Display -->
                            <div class="flex-1 max-w-xs">
                                <input 
                                    type="number" 
                                    id="towelCount" 
                                    name="towelCount"
                                    min="1"
                                    max="20"
                                    value="1"
                                    class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors text-2xl font-bold text-center bg-gray-50"
                                    readonly
                                    required
                                >
                            </div>

                            <!-- Increase Button -->
                            <button 
                                type="button" 
                                id="increaseBtn"
                                class="w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-center mt-2 text-sm text-gray-500">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡∏´‡∏£‡∏∑‡∏≠ - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Notes & Submit -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-end">
                    <!-- Notes -->
                    <div class="lg:col-span-2">
                        <label for="notes" class="block text-sm font-semibold text-gray-700 mb-2">
                            üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                        </label>
                        <textarea 
                            id="notes" 
                            name="notes"
                            rows="3"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors resize-none"
                            placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                        ></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg transition-colors duration-200 text-lg shadow-lg hover:shadow-xl h-[84px] flex items-center justify-center"
                        >
                            <span id="submitText">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                            <span id="loadingText" class="loading">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
                            </span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Success/Error Messages -->
            <div id="message" class="mt-6 p-4 rounded-lg hidden">
                <p id="messageText" class="font-medium"></p>
            </div>
        </div>

        <!-- Tab Section -->
        <div class="max-w-4xl mx-auto mt-12">
            <!-- Tab Headers -->
            <div class="bg-white rounded-t-2xl shadow-xl p-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-records" type="button" class="tab-btn tab-active font-medium text-center text-indigo-600 bg-indigo-100 rounded-md px-4 py-2 text-sm transition-all">
                        üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </button>
                    <button id="tab-export" type="button" class="tab-btn font-medium text-center text-gray-500 hover:bg-gray-100 hover:text-gray-700 rounded-md px-4 py-2 text-sm transition-all">
                        üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </nav>
            </div>

            <!-- Tab Panels -->
            <div class="bg-white rounded-b-2xl shadow-xl">
                <!-- Panel 1: Records -->
                <div id="panel-records" class="tab-panel p-8">
                    <div class="flex justify-end items-center mb-6">
                        <button 
                            id="refreshBtn"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                        >
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                    <div id="recordsContainer" class="overflow-x-auto">
                        <div class="text-center py-8 text-gray-500">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Export -->
                <div id="panel-export" class="tab-panel p-8 hidden">
                    <div class="space-y-4">
                        <!-- Radio buttons for type selection -->
                        <div>
                            <span class="text-gray-700 font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å:</span>
                            <div class="mt-2 flex items-center space-x-6">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" class="form-radio text-indigo-600" name="exportType" value="daily" checked>
                                    <span class="ml-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" class="form-radio text-indigo-600" name="exportType" value="monthly">
                                    <span class="ml-2">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                </label>
                            </div>
                        </div>

                        <!-- Date/Month inputs -->
                        <div id="dailyExport" class="space-y-2">
                            <label for="exportDate" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                            <input type="date" id="exportDate" name="exportDate" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div id="monthlyExport" class="space-y-2 hidden">
                            <label for="exportMonth" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                            <input type="month" id="exportMonth" name="exportMonth" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <!-- Export Button -->
                        <div>
                            <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-lg">
                                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV
                            </button>
                        </div>
                    </div>
                     <div id="exportMessage" class="mt-4 p-4 rounded-lg hidden text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSgc7SBt_GyKtUkziObMUZGDvY5BtTLO4JK-udSGSG-Hv5Nw_JcBl4TKLc6yY7F8TWjw/exec';
        
        let todayRecords = []; // Store today's records for duplicate checking

        // Check if room number already exists today and return details
        function checkRoomDuplicate(roomNumber) {
            if (!roomNumber) return null;
            
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            const duplicateRecord = todayRecords.find(record => {
                if (!record[0] || !record[1]) return false;
                
                const recordDateStr = record[0].toString();
                let recordDate;
                
                if (recordDateStr.includes('/')) {
                    const parts = recordDateStr.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        recordDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else if (recordDateStr.includes('-')) {
                    recordDate = new Date(recordDateStr.split(' ')[0]);
                } else {
                    recordDate = new Date(recordDateStr);
                }
                
                if (isNaN(recordDate.getTime())) return false;
                
                const recordDateFormatted = recordDate.getFullYear() + '-' + 
                                          String(recordDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                          String(recordDate.getDate()).padStart(2, '0');
                
                return recordDateFormatted === todayStr && record[1].toString().trim() === roomNumber.trim();
            });
            
            return duplicateRecord || null;
        }

        // Format time difference
        function getTimeDifference(recordTimeStr) {
            try {
                const parts = recordTimeStr.split(/[\s/:]+/);
                const recordTime = new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5]);

                const now = new Date();
                const diffMs = now - recordTime;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMinutes / 60);
                
                if (diffMinutes < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                if (diffMinutes < 60) return `${diffMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffHours < 24) {
                     const remainingMinutes = diffMinutes % 60;
                     return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${remainingMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                }
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
            } catch (error) {
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
            }
        }

        // Form submission
        document.getElementById('towelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            
            const formData = new FormData(this);
            const roomNumber = formData.get('roomNumber').trim();
            const customerName = formData.get('customerName').trim();
            
            if (!roomNumber && !customerName) {
                showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            const duplicateRecord = checkRoomDuplicate(roomNumber);
            if (roomNumber && duplicateRecord) {
                const timeDiff = getTimeDifference(duplicateRecord[0]);
                showMessage(`‚ùå ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${timeDiff})`, 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            loadingText.classList.add('show');
            
            try {
                const data = {
                    action: 'addRecord',
                    roomNumber: roomNumber,
                    customerName: customerName,
                    status: formData.get('status'),
                    towelCount: parseInt(formData.get('towelCount')),
                    notes: formData.get('notes') || ''
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain',},
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    this.reset();
                    document.getElementById('towelCount').value = 1; 
                    loadRecords();
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                loadingText.classList.remove('show');
            }
        });

        // Load recent records
        async function loadRecords() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getRecords', { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                if (result.success && result.data) {
                    todayRecords = result.data;
                    displayRecords(result.data);
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsContainer').innerHTML = 
                    `<div class="text-center py-8 text-red-500">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}</div>`;
            }
        }

        // Display records in table
        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3">${record[0] || ''}</td>
                                <td class="px-4 py-3 font-medium">${record[1] || ''}</td>
                                <td class="px-4 py-3">${record[2] || ''}</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                        record[3] === 'Check In' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                    }">
                                        ${record[3] || ''}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center font-medium">${record[4] || ''}</td>
                                <td class="px-4 py-3">${record[5] || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            container.innerHTML = table;
        }

        // Show message
        function showMessage(text, type) {
            const message = document.getElementById('message');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            message.className = `mt-6 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            message.classList.remove('hidden');
            setTimeout(() => { message.classList.add('hidden'); }, 5000);
        }

        // Towel count controls
        const towelCountInput = document.getElementById('towelCount');
        document.getElementById('increaseBtn').addEventListener('click', () => {
            let val = parseInt(towelCountInput.value) || 1;
            if (val < 20) towelCountInput.value = val + 1;
        });
        document.getElementById('decreaseBtn').addEventListener('click', () => {
            let val = parseInt(towelCountInput.value) || 1;
            if (val > 1) towelCountInput.value = val - 1;
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadRecords);

        // Real-time validation
        document.getElementById('roomNumber').addEventListener('input', function() {
            const roomWarning = document.getElementById('roomWarning');
            const customerNameRequired = document.getElementById('customerNameRequired');
            if (this.value.trim()) {
                const duplicateRecord = checkRoomDuplicate(this.value.trim());
                if (duplicateRecord) {
                    roomWarning.textContent = `‚ö†Ô∏è ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${getTimeDifference(duplicateRecord[0])})`;
                    roomWarning.classList.remove('hidden');
                } else {
                    roomWarning.classList.add('hidden');
                }
                customerNameRequired.classList.add('hidden');
            } else {
                roomWarning.classList.add('hidden');
            }
        });

        // Load records on page load
        window.addEventListener('load', loadRecords);

        // --- Tab Logic ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Deactivate all buttons and panels
                tabButtons.forEach(btn => {
                    btn.classList.remove('tab-active', 'text-indigo-600', 'bg-indigo-100');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-100', 'hover:text-gray-700');
                });
                tabPanels.forEach(panel => {
                    panel.classList.add('hidden');
                });

                // Activate clicked button and corresponding panel
                button.classList.add('tab-active', 'text-indigo-600', 'bg-indigo-100');
                button.classList.remove('text-gray-500', 'hover:bg-gray-100', 'hover:text-gray-700');
                
                const targetPanelId = button.id.replace('tab-', 'panel-');
                document.getElementById(targetPanelId).classList.remove('hidden');
            });
        });


        // --- Export Logic ---
        const dailyExportDiv = document.getElementById('dailyExport');
        const monthlyExportDiv = document.getElementById('monthlyExport');
        const exportDateInput = document.getElementById('exportDate');
        const exportMonthInput = document.getElementById('exportMonth');
        const exportBtn = document.getElementById('exportBtn');
        const exportMessage = document.getElementById('exportMessage');

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        exportDateInput.value = `${yyyy}-${mm}-${dd}`;
        exportMonthInput.value = `${yyyy}-${mm}`;

        document.querySelectorAll('input[name="exportType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'daily') {
                    dailyExportDiv.classList.remove('hidden');
                    monthlyExportDiv.classList.add('hidden');
                } else {
                    dailyExportDiv.classList.add('hidden');
                    monthlyExportDiv.classList.remove('hidden');
                }
            });
        });

        exportBtn.addEventListener('click', function() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            let exportDate = (exportType === 'daily') ? exportDateInput.value : exportMonthInput.value;
            
            if (!exportDate) {
                showExportMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${exportType === 'daily' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}`, 'error');
                return;
            }

            showExportMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
            const exportUrl = `${SCRIPT_URL}?action=exportCsv&type=${exportType}&date=${exportDate}`;
            window.open(exportUrl, '_blank');
            setTimeout(() => { exportMessage.classList.add('hidden'); }, 3000);
        });
        
        function showExportMessage(text, type) {
            exportMessage.textContent = text;
            exportMessage.className = `mt-4 p-4 rounded-lg text-sm ${
                type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
            }`;
            exportMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>

